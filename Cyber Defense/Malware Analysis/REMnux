REMnux
-identify and analyze malicious payloads of various formats embedded in pdfs exes and MS office macros

username: remnux
pass: malware

ssh remnux@IP
-enter pass
--------------------------------------------------------------------------------------------
Analysing Malicious PDFs

-PDF's are capable of containing code that can be executed without the user's knowledge
-javascript, python, executables, powershell shellcode

1. Looking for embedded javascript
-use peepdf
peepdf notsuspicious.pdf
-3 suspicous elements
/OpenAction
/JS
/JavaScript

-OpenAction - will execute the code when the PDF is launched
-can exxtract the javascript using peepdf
echo 'extract js > javascript-from-notsuspicious.pdf' > extrated_js.txt
peepdf -s extracted_js.txt notsuspicious.pdf
cat javascript-from-notsuspicious.pdf
THM{Luckily_This_Isn't_Harmful}

peepdf advert.pdf
-6 suspicious elements
/OpenAction
/Names
/AA
/JS
/Launch
/JavaScript

echo 'extract js > javascript-from-advert.pdf' > extracted_js_advert.txt
peepdf -s extracted_js_advert.txt advert.pdf
cat javascript-from-advert.pdf
-cName: "notsuspicious"

-------------------------------------------------------------------------------------------------

Analyzing malicious microsoft office macros

-Seemingly legitimate documents attached to emails eg invoice for business can infect users who open the files
-eg. Emotet and QuickBot
-"dropper attack" - additional malicious programs are downloaded onto the host
-done in the background without popup
-Antivirus services can pickup on this activity whe it is left in plaintext
-obfuscated payload code:
1. macro starts once edit permission has been enabled and edit mode on the word document
2. the macro executes the payload stored in the text within the document
-downside is users will be suspicious with large amount of unfamiliar text
-the text color could be made similar to the background to hide it 

-Analysis using vmonkey
-vmonkey: parser engine that is capable of analyzing visual basic macros without executing(opening the document)
vmonkey DefinitelyALegitInvoice.doc
-Macro: DefoLegit
vmonkey Taxes2020.doc
-URL to launch: http://tryhackme.com/notac2cserver.sh

---------------------------------------------------------------------------------------------

Entropy 101
-Entropy: is indicative of the suspiciousness of a file and a is a prominent characteristic that tools look for within a PE (portable executable)
-rating that scores how random the data within a PE file is
-scale is 0 to 8 in randomness
-0: less random
-8: more random
-encrypted file will have high entropy ~ 8 
-files with large chunks of same data ~ 1
-Malware authors use techniques such as encryption or packing to obfuscate their code and attempt to bypass anti-virus
-If an anlyst had 1000 files they could rand the files by their entropy score 
-files with the higher entropy should be analyzed first

Packing and Unpacking
-packer use an executable as a source and output another executable
-new executable could be compressed/obfuscated using mathematics
-legitimate software developers use packing to reduce the size of their apps and prevent theft
-makes reverse engineering difficult
-Entry point: location of the first pieces of code to be executed within the file
-If exe is packed, it must unpack before any code can execute -> change entry point to another location -> "Unpacking Stub"
-Unpacking stub: begins to unpack the exe into orginal state
-entry point will relocate back to normal place and start executing code

Determining if exe is packed
-Packed files have high entropy
-few imports, only have "GetProcAddress" and "LoadLibrary"
-exe may have sections nameed after certain packers such as UPX
-use tool PEID to which packer was used

most common packer: UPX

-------------------------------------------------------------------------------------------------------------

Memory Forensics
-Using Volatility: https://tryhackme.com/room/bpvolatility
volatility -f Win7-Jigsaw.raw --profile=Win7SP1x64 pslist
-drpbx.exe with PID of 3704 
-DLL's are structured to executables but they cannont be directly executed and multipe apps can interact with a DLL
volatility -f Win7-Jigsaw.raw --profile=Win7SP1x64 dlllist -p 3704
-CRYPTBASE.dll stands out
-allows applications to use cryptography

-------------------------------------------------------------------------------------------------------

Go further

Reading:
1. A Look at Entropy Analysis: https://fsec404.github.io/blog/Shanon-entropy/
2. Investigating Malware using Memory Forensics: https://www.youtube.com/watch?v=BMFCdAGxVN4
3. Malware Threat Report - Q2 2020 (Avira): https://www.avira.com/en/blog/malware-threat-report-q2-2020-statistics-and-trends
4. Malware Detection in PDF and Office Documents: A survery: https://api.semanticscholar.org/CorpusID:212680542%20(P.%20Singh,%20S.%20Tapaswi,%20S.Gupta)




